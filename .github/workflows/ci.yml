name: ci

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - uses: hashicorp/setup-terraform@v3
      - name: fmt
        run: |
          test -z "$(gofmt -l $(find . -name '*.go' -not -path './vendor/*'))"
      - name: test
        run: go test ./...
      - name: integration
        run: |
          set -euo pipefail
          mkdir -p /tmp/tf-dev-provider
          go build -o /tmp/tf-dev-provider/terraform-provider-haproxy-dataplane .
          cat > /tmp/tf-dev.tfrc <<'EOF'
          provider_installation {
            dev_overrides {
              "pderuiter/haproxy-dataplane" = "/tmp/tf-dev-provider"
            }
            direct {}
          }
          EOF
          TF_CLI_CONFIG_FILE=/tmp/tf-dev.tfrc ./scripts/registry_integration.sh
      - name: runtime-integration
        run: |
          set -euo pipefail
          ./scripts/registry_runtime_integration.sh
